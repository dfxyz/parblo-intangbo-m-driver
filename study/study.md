# USB数据分析

通过Wireshark抓包可以得知，「Parblo Intangbo M」提供了三个接口，其中两个符合HID规范，提供键盘、鼠标与绘图板设备的标准用途。另外一个接口则是实现了厂商的私用用途，它的bInterfaceNum为2，输入事件使用bEndpointAddress=0x83，输出事件使用bEndpointAddress=0x03。这个接口上的HID报告如下：
- Usage Page (0xff0a)
    - Usage (0x01)
    - Collection (Application)
        - Report ID (0x02)
            - Usage (0x02)
                - Report Size (8)
                - Report Count (9)
                - Logical Minimum (0)
                - Logical Maximum (255)
                - Input (Data,Var,Abs)
            - Usage (0x03)
                - Report Size (8)
                - Report Count (7)
                - Logical Minimum (0)
                - Logical Maximum (255)
                - Output (Data,Var,Abs)
        - End Collection
- Usage Page (0xff0b)
    - Usage (0x04)
    - Collection (Application)
        - Report ID (0xfe)
            - Usage (0x05)
                - Report Size (8)
                - Report Count (131)
                - Logical Minimum (0)
                - Logical Maximum (255)
                - Input (Data,Var,Abs)
            - Usage (0x06)
                - Report Size (8)
                - Report Count (64)
                - Logical Minimum (0)
                - Logical Maximum (255)
                - Output (Data,Var,Abs)
        - End Collection
- Usage Page (0xff0c)
    - Usage (0x07)
    - Collection (Application)
        - Report ID (0xfd)
            - Usage (0x08)
                - Report Size (8)
                - Report Count (1100)
                - Output (Data,Array,Abs)
        - Report ID (0xfc)
            - Usage (0x09)
                - Report Size (8)
                - Report Count (1100)
                - Input (Data,Array,Abs)
        - End Collection

通过观察Windows下运行官方的驱动程序时主机与设备之间的通信，发现双方会在私有用途的接收上收发下列握手信息：
```
OUT 0xFD
0000   fd 89 ff ff 00 00 00 06 00 00 03 01 01 01 91 20   ...............
- 89 ff ff
- 0x0000 (message number)
- 00 06 00 00 (6 bytes)
- [03 01 01 01]
- 91 20

IN 0xFC
0000   fc 76 01 ff 00 00 00 09 00 00 03 01 01 01 00 00   .v..............
0010   01 61 5b 00 00 00 00 00 00 00 00 00 00 00 00 00   .a[.............
- 76 01 ff
- 0x0000 (message number)
- 00 09 00 00 (9 bytes)
- [03 01 01 01]
- 00 00 01 61 5b


OUT 0xFD
0000   fd 89 ff ff 00 01 00 06 00 00 01 01 02 02 fd 58   ...............X
- 89 ff ff
- 0x0001 (message number)
- 00 06 00 00 (6 bytes)
- [01 01 02 02]
- fd 58

IN 0xFC
0000   fc 76 01 ff 00 01 00 57 00 00 01 01 02 02 00 00   .v.....W........
0010   01 04 00 4d 61 79 20 33 30 20 32 30 32 34 20 31   ...May 30 2024 1
0020   39 3a 31 38 3a 34 33 00 00 00 00 00 00 00 00 00   9:18:43.........
0030   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0040   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0050   00 00 00 02 02 16 0c 1c 0b 01 01 01 01 01 01 7e   ...............~
0060   c4 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
- 76 01 ff
- 0x0001 (message number)
- 00 57 00 00 (87 bytes)
- [01 01 02 02] ...

OUT 0xFD
0000   fd 89 ff ff 00 02 00 06 00 00 01 01 02 04 4e 69   ..............Ni
- 89 ff ff
- 0x0002 (message number)
- 00 06 00 00 (6 bytes)
- [01 01 02 04]
- 4e 69

IN 0xFC
0000   fc 76 01 ff 00 02 00 0b 00 00 01 01 02 04 00 00   .v..............
0010   02 00 ff 72 f7 79 20 33 30 20 32 30 32 34 20 31   ...r.y 30 2024 1
0020   39 3a 31 38 3a 34 33 00 00 00 00 00 00 00 00 00   9:18:43.........
0030   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0040   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0050   00 00 00 02 02 16 0c 1c 0b 01 01 01 01 01 01 7e   ...............~
0060   c4 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
- 76 01 ff
- 0x0002 (message number)
- 00 0b 00 00 (11 bytes)
- [01 01 02 04]
- 00 00 02 00 ff 72 f7 79 20 33 30

OUT 0x02
0000   02 b0 04 00 00 00 00 00                           ........

IN 0x02
0000   02 b1 04 00 00 00 00 00 00 00                     ..........

```
完成上述过程后，绘图板上报按键或画笔事件时，不再使用前两个接口，而是使用第三个私有接口。如果杀掉驱动进程，绘图板不再上报任何输入事件。重启驱动程序后，绘图板与主机重复上述握手过程，后续通过私有接口恢复上报输入事件。

## 按键事件
按键事件首个字节为`f0(11110000)`，第二个字节为按键状态，每个比特位对应其中一个按键。如果转动转环，或按下转换中间的按钮，此时第二个字节固定为0x08，第三个字节的第三位分别对应顺时针转动转环、逆时针转动转环、按下转换中间的按钮。

输入事件数据样本：
```
Reset
0000   02 f0 00 00 00 00 00 00 00 00

Button0
0000   02 f0 01 00 00 00 00 00 00 00

Button1
0000   02 f0 02 00 00 00 00 00 00 00

Button2
0000   02 f0 04 00 00 00 00 00 00 00

Button3
0000   02 f0 08 00 00 00 00 00 00 00

Button4
0000   02 f0 10 00 00 00 00 00 00 00

Button5
0000   02 f0 20 00 00 00 00 00 00 00

Button6
0000   02 f0 40 00 00 00 00 00 00 00

Button7
0000   02 f0 80 00 00 00 00 00 00 00

Ring Counter-clockwise
0000   02 f0 08 02 00 00 00 00 00 00

Ring Clockwise
0000   02 f0 08 01 00 00 00 00 00 00

Ring Button
0000   02 f0 08 03 00 00 00 00 00 00
```

## 笔事件
观察到第一个字节的高4位可能为下列值：
- 0xa，对应笔进入感应区域
- 0xc，对应笔离开感应区域
观察到第一个字节的低3位分别对应下列事件：
- 笔尖按下
- 画笔下方侧键按下
- 画笔上方侧键按下
第2、3字节为小端表示的X轴坐标，第4、5字节为小端表示的Y轴坐标，第6、7字节为小端表示的笔尖压力，第8字节为X轴倾斜（int8），第9字节为Y轴倾斜（int8）。

输入事件数据样本：
```
左上
0000   02 a0 5b 03 30 03 00 00 03 fc
0000   02 a0 10 04 f3 02 00 00 f8 fb
0000   02 a0 8c 04 16 03 00 00 0a f7
0x035b,0x0330,0xfc03 -> 859,816
0x0410,0x02f2,0xfbf8 -> 1040,754
0x048c,0x0316,0xf70a -> 1164,790

左下
0000   02 a0 0b 02 0d 3e 00 00 c4 c4
0000   02 a0 b6 02 9f 3d 00 00 f0 e8
0000   02 a0 c0 02 94 3d 00 00 f6 e6
0x020b,0x3e0d,0xc4c4 -> 523,15885
0x02b6,0x3d9f,0xe8f0 -> 694,15775
0x02c0,0x3d94,0xe6f6 -> 704,15764

右下
0000   02 a0 54 64 1e 3e 00 00 c4 c4
0000   02 a0 93 63 86 3c 00 00 07 04
0000   02 a0 8a 63 91 3c 00 00 0f 14
0x6454,0x3e1e,0xc4c4 -> 25940,15902
0x6393,0x3c86,0x0407 -> 25491,15494
0x638a,0x3c91,0x140f -> 25482,15505

右上
0000   02 a0 88 64 85 03 00 00 c4 c4
0000   02 a0 80 64 3f 03 00 00 d7 e9
0000   02 a0 9e 64 3f 03 00 00 dc fa
0x6488,0x0385,0xc4c4 -> 25736,901
0x6480,0x033f,0xe9d7 -> 25728,831
0x649e,0x033f,0xfadc -> 25758,831
```
