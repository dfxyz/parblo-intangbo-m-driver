![Parblo Intangbo M](https://www.parblo.com/cdn/shop/products/PA000020_new_com4_1000x.jpg)

「Parblo Intangbo M」绘图板的Linux“驱动程序”，通过rusb/libusb和evdev-rs/libuinput在用户空间中实现。

本程序提供下列功能：
- 修正在Linux PC环境中使用时，绘图板方向与显示器方向偏转了90度的问题（设备本身有精度丢失，具体见后文「已知问题」）
- 支持自定义按键映射（包括画笔上的两个侧键），并支持：
    - 配置多套按键映射方案（映射某个按键为方案切换键来使用）
    - 在程序运行时动态更改配置

# 使用方法
## 前置准备
- 编译本程序：`cargo build --release`
- 按需配置udev规则，插入设备时自动运行本程序（vendor_id=0x0483，product_id=0xa013）
- 将绘图板连接Android设备，利用官方的APP为绘图板设置一个对应PC显示器的长宽比
- 准备一份TOML格式的配置文件（`config.example.toml`文件提供了一个示例，具体配置方法可见后文「按键配置说明」）

## 运行程序
在设备连接Linux主机后，运行本程序（需要root权限）。

基本用法：
```
sudo ./parblo-intangbo-m-driver [CONFIG_PATH]
```

可选参数`CONFIG_PATH`对应配置文件的路径。如未指定，将使用空配置（不配置任何按键映射）。

注意：启动本程序后，绘图板将停止使用原先的HID兼容接口与主机通信；因此在关闭本程序时，绘图板将无法向主机发送任何输入事件（重启本程序即可恢复正常）。

# 配置说明

配置文件使用TOML格式。目前主要分为`schema`数组（对应绘图板上的按键映射）和其他字段两部分。

## 绘图板按键配置说明
在TOML配置文件中，需要配置一个或多个`schema`数组元素，每一个`schema`对应一个按键方案。若没有特别说明，所有字段均支持热更新。

在`schema`中，可以配置下列字段：
- `button0`~`button7`：对应绘图板上左侧从上到下的八个普通按键
- `ring0`：对应转环逆时针旋转
- `ring1`：对应转环顺时针旋转
- `ringButton`：对应转环中间的按钮

每个字段可以配置为：
- 普通按键
    ```
    a~z 0-9 - = \ ` [ ] ; ' , . /
    esc tab backspace enter space
    home end pageup pagedown insert delete
    ```
- 使用`ctrl`、`shift`、`alt`、`meta`等修饰键进行组合，例如：
    ```
    ctrl+a
    shift+b
    alt+c
    meta+d
    ctrl+shift+e
    ctrl+alt+f
    ...
    ```
- 特殊行为：
    - `switchSchema`：切换到下一个配置方案
    - `fallback`：使用前一个配置方案的按键映射；如果没有，则什么都不做
    - `none`：禁用该按键

若某个字段未配置，默认使用`fallthrough`。

## 其他配置说明
- `xMaxValue`：用于修正X轴的最大值；若未配置，使用设备报告描述符中提供Y轴的最大值；可选，但注意该字段**不支持热更新**
- `yMaxValue`：用于修正Y轴的最大值；若未配置，使用设备报告描述符中提供X轴的最大值；可选，但注意该字段**不支持热更新**
- `xMap`：将X轴的值映射到指定的比例闭区间内，从而实现映射到显示器的某个区域的效果；数值范围为`[0.0, 1.0]`；可选
- `yMap`：将Y轴的值映射到指定的比例闭区间内，从而实现映射到显示器的某个区域的效果；数值范围为`[0.0, 1.0]`；可选

# 已知问题
由于官方本身只支持Windows与Android，而Android与Linux使用同一套USB协议栈，因此在Linux PC环境中使用该绘图板时，设备会将Linux主机识别成Android，并工作在Android模式——画笔在长边移动时，上报Y轴变化事件；在短边移动时，上报X轴变化事件——因此表现为绘图板方向与显示器方向偏转了90度。除此之外，可能是固件的缺陷，X轴和Y轴的数值范围并没有因为绘图板的长短边调换而相应地调整。当绘图板的对应的屏幕长宽比设置为16:9时，画笔在较长边的坐标范围为`[0, 16200]`，而在较短边的坐标范围为`[0, 28800]`，因此可以推断出绘图板在Android模式下工作时，在较长边的感应精度是降低了的。
